<!doctype html>
                     <html lang="es">
                     <head>
                       <meta charset="utf-8">
                       <title>Visor Markdown</title>
                       <meta name="viewport" content="width=device-width, initial-scale=1" />
                       <!-- Mermaid para bloques ```mermaid -->
                       <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
                       <style>
                         :root{
                              --bg:#0b1020; --fg:#e5e7eb; --link:#8ab4f8; --border:#243148; --card:#12182c; --muted:#a3a3a3; --codebg:#0f172a;
                            }
                            :root[data-theme="light"]{
                              --bg:#ffffff; --fg:#0f172a; --link:#1a56db; --border:#e5e7eb; --card:#f8fafc; --muted:#6b7280; --codebg:#f3f4f6;
                            }
                            *{box-sizing:border-box}
                            body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Noto Color Emoji;margin:2rem;line-height:1.6;background:var(--bg);color:var(--fg)}
                            a{color:var(--link)}
                            pre,code{background:var(--codebg);color:var(--fg);border-radius:6px}
                            pre{padding:1rem;overflow:auto}
                            code{padding:0.15rem 0.35rem}
                            h1,h2,h3,h4{margin-top:1.2em}
                            img{max-width:100%; height:auto}
                            table{border-collapse:collapse;width:100%;overflow:auto;display:block}
                            th,td{border:1px solid var(--border);padding:6px}
                            .path{color:var(--muted);margin-bottom:1rem;word-break:break-all}
                            .error{color:#fca5a5}
                            .back{display:inline-block;background:var(--card);color:var(--link);border:1px solid var(--border);border-radius:8px;padding:.5rem 1rem;font-size:.95rem;cursor:pointer;transition:background .2s,transform .1s}
                            .back:hover{transform:translateY(-1px)}
                            .back:active{transform:translateY(0)}
                            #themeToggle{
                              position:fixed; top:16px; right:16px; z-index:10;
                              border:1px solid var(--border); background:var(--bg); color:var(--link);
                              border-radius:10px; padding:.45rem .7rem; cursor:pointer;
                            }
                       </style>
                     </head>
                     <body>
                       <button class="back" onclick="window.location.href='index.html'">‚Üê Volver al √≠ndice</button> <button id="themeToggle" aria-label="Cambiar tema">‚òÄÔ∏è Modo blanco</button>

                       <div class="path" id="mdpath"></div>
                       <article id="content">Cargando‚Ä¶</article>

                       <script>
                        const applyTheme = (t) => document.documentElement.setAttribute('data-theme', t);
                        const saved = localStorage.getItem('theme') || 'dark';
                        applyTheme(saved);
                        const btn = document.getElementById('themeToggle');
                        const updateBtn = () => { btn.textContent = (document.documentElement.getAttribute('data-theme')==='light') ? 'üåô Modo oscuro' : '‚òÄÔ∏è Modo blanco'; };
                        updateBtn();
                        btn.onclick = () => {
                          const now = document.documentElement.getAttribute('data-theme')==='light' ? 'dark' : 'light';
                          applyTheme(now); localStorage.setItem('theme', now); updateBtn();
                        };
                       const esc = s => s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

                       function md2html(md){
                         // 1) Mermaid: bloques ```mermaid ... ```
                         md = md.replace(/```mermaid\s*([\s\S]*?)```/g, (_,code)=>`<div class="mermaid">${code}</div>`);
                         
                         md = md.replace(/(```|~~~)[ \t]*mermaid[ \t]*\n([\s\S]*?)\1/gi, (_, fence, code) => {
                        return `<div class="mermaid">${code}</div>`;
                        });
                        
                        md = md.replace(/(```|~~~)(?![ \t]*mermaid)([^\n]*)\n([\s\S]*?)\1/g, (_, fence, lang, code) => {
                        return `<pre><code>${esc(code)}</code></pre>`;
                        });

                         // 2) C√≥digo normal con triple backticks
                         md = md.replace(/```([\s\S]*?)```/g, (_,code)=>`<pre><code>${esc(code)}</code></pre>`);

                         // Inline code
                         md = md.replace(/`([^`]+)`/g, (_,code)=>`<code>${esc(code)}</code>`);

                         // Cabeceras
                         md = md.replace(/^######\s?(.*)$/gm,'<h6>$1</h6>')
                                .replace(/^#####\s?(.*)$/gm,'<h5>$1</h5>')
                                .replace(/^####\s?(.*)$/gm,'<h4>$1</h4>')
                                .replace(/^###\s?(.*)$/gm,'<h3>$1</h3>')
                                .replace(/^##\s?(.*)$/gm,'<h2>$1</h2>')
                                .replace(/^#\s?(.*)$/gm,'<h1>$1</h1>');

                         // Listas
                         md = md.replace(/^\s*[-*+]\s+(.*)$/gm,'<li>$1</li>');
                         md = md.replace(/(<li>[\s\S]*?<\/li>)(?:(\n(?!<li>))+)/g, '<ul>$1</ul>\n');
                         md = md.replace(/^\s*\d+\.\s+(.*)$/gm,'<li>$1</li>');
                         md = md.replace(/(<li>[\s\S]*?<\/li>)(?:(\n(?!<li>))+)/g, m=> m.includes('<ul>')? m : '<ol>'+m+'</ol>\n');

                         // √ânfasis
                         md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
                                .replace(/\*([^*]+)\*/g,'<em>$1</em>')
                                .replace(/__([^_]+)__/g,'<strong>$1</strong>')
                                .replace(/_([^_]+)_/g,'<em>$1</em>');

                         // Im√°genes y enlaces (sin resolver a√∫n rutas relativas)
                         md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (_,alt,src)=>`<img alt="${esc(alt)}" src="${esc(src)}">`);
                         md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_,text,href)=>`<a href="${esc(href)}" target="_blank" rel="noopener">${esc(text)}</a>`);

                         // Tablas simples estilo GitHub
                         md = md.replace(/^(?:\|.+\|\n)+/gm, block=>{
                           const rows = block.trim().split('\n').map(r=>r.replace(/^\||\|$/g,'').split('|'));
                           const head = rows.shift(); if(!head) return block;
                           const sep = rows[0] && rows[0].every(c=>/^\s*:?-+:?\s*$/.test(c)) ? rows.shift() : null;
                           const thead = '<thead><tr>'+head.map(c=>`<th>${esc(c.trim())}</th>`).join('')+'</tr></thead>';
                           const tbody = '<tbody>'+rows.map(r=>'<tr>'+r.map(c=>`<td>${esc(c.trim())}</td>`).join('')+'</tr>').join('')+'</tbody>';
                           return `<table>${thead}${tbody}</table>`;
                         });

                         // P√°rrafos (evita envolver bloques ya HTML como pre/table/img/blockquote/div.mermaid)
                         md = md.split(/\n{2,}/).map(block=>{
                           const t = block.trim();
                           if (/^<(h\d|ul|ol|pre|table|img|blockquote|div\b)/i.test(t)) return block;
                           return '<p>'+block.replace(/\n/g,'<br>')+'</p>';
                         }).join('\n');

                         return md;
                       }

                       // Resuelve URLs relativas; si apuntan a carpeta, env√≠a a README.md (fallback index.md)
                       function resolveRelativeUrls(container, basePath){
                         const toRawPath = (p) => p.split('/').map(encodeURIComponent).join('/');
                         const baseDir = basePath.substring(0, basePath.lastIndexOf('/')+1);
                         const isHttp = u => /^(https?:)?\/\//i.test(u);
                         const hasExt = seg => /\.[a-z0-9]+$/i.test(seg);

                         const fixLink = (a) => {
                              let href = a.getAttribute('href');
                              if (!href) return;
                            
                              if (isHttp(href)) return;
                            
                              href = href.replace(/^\.\//, '').replace(/\/{2,}/g,'/');
                            
                              if (/\.mdx?$/i.test(href)) {
                                const raw = baseDir + toRawPath(href);
                                a.setAttribute('href', 'viewer.html?file=' + raw);
                                a.setAttribute('target','_self');
                                return;
                              }
                            
                              const parts = href.split('/');
                              const last = parts.filter(Boolean).pop() || '';
                              const looksDir = href.endsWith('/') || !hasExt(last);
                            
                              if (looksDir) {
                                const cand1 = baseDir + toRawPath(href.replace(/\/?$/,'/') + 'README.md');
                                const cand2 = baseDir + toRawPath(href.replace(/\/?$/,'/') + 'index.md');
                                a.setAttribute('href', 'viewer.html?file=' + cand1);
                                a.setAttribute('target','_self');
                                a.setAttribute('data-fallback', 'viewer.html?file=' + cand2);
                                return;
                              }
                            
                              a.setAttribute('href', baseDir + toRawPath(href));
                              a.setAttribute('target','_blank');
                            };

                         container.querySelectorAll('img').forEach(img => {
                          const src = img.getAttribute('src');
                          if (!src || /^(https?:)?\/\//i.test(src)) return;
                          const fixed = src.replace(/^\.\//,'').replace(/\/{2,}/g,'/');
                          img.setAttribute('src', baseDir + fixed.split('/').map(encodeURIComponent).join('/'));
                        });

                         container.querySelectorAll('a').forEach(a=>fixLink(a,'href'));
                       }

                       // Render
                       const params = new URLSearchParams(location.search);
                       let file = params.get('file');
                       document.getElementById('mdpath').textContent = file || '';

                       if (!file) {
                        document.getElementById('content').innerHTML = '<p>No se indic√≥ archivo (?file=...)</p>';
                      } else {
                        fetch(file)
                          .then(r => {
                            if (!r.ok) throw new Error('No se pudo cargar ' + file + ' (' + r.status + ')');
                            return r.text();
                          })
                          .then(txt => {
                            // console.log("Markdown descargado:", txt.slice(0,200));
                            const html = md2html(txt);
                            const content = document.getElementById('content');
                            content.innerHTML = html;
                            resolveRelativeUrls(content, file);
                    
                            if (window.mermaid) {
                              try {
                                mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
                                mermaid.run({ querySelector: '.mermaid' });
                              } catch (e) {
                                console.error('Mermaid error:', e);
                              }
                            }
                          })
                          .catch(e => {
                            const content = document.getElementById('content');
                            content.innerHTML = '<p class="error">Error: ' + (e && e.message ? e.message : e) + '</p>';
                          });
                      }
                       </script>
                     </body>
                     </html>
